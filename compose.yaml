name: understandtech

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "5"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3

services:

  caddy:
    image: caddy:2-alpine
    container_name: ut-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - ut-frontend-network
    depends_on:
      api:
        condition: service_healthy
      frontend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      <<: *healthcheck-defaults
      start_period: 10s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 64M

  redis:
    image: redis:7.2-alpine
    container_name: ut-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
    expose:
      - "6379"
    volumes:
      - redis-data:/data
    networks:
      - ut-backend-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      <<: *healthcheck-defaults
      interval: 10s
      start_period: 5s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 256M

  mongodb:
    image: mongo:8.2
    container_name: ut-mongodb
    restart: unless-stopped
    expose:
      - "27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USERNAME:-}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-}
    command: >
      mongod
      --wiredTigerCacheSizeGB 1
      --setParameter diagnosticDataCollectionEnabled=false
    volumes:
      - mongodb-data:/data/db
    networks:
      - ut-frontend-network
      - ut-backend-network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok", "-u", "${MONGODB_USERNAME:-}", "-p", "${MONGODB_PASSWORD:-}", "--authenticationDatabase", "admin"]
      <<: *healthcheck-defaults
      start_period: 30s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 1G

  mongodb-backup:
    image: tiredofit/db-backup:latest
    container_name: ut-mongodb-backup
    restart: unless-stopped
    environment:
      TIMEZONE: ${TIMEZONE:-UTC}
      CONTAINER_ENABLE_MONITORING: FALSE
      DEFAULT_LOG_LEVEL: INFO

      DB01_TYPE: mongo
      DB01_HOST: mongodb
      DB01_PORT: ${MONGODB_PORT:-27017}
      DB01_NAME: ${MONGODB_DATABASE:-ut-db}
      DB01_USER: ${MONGODB_USERNAME:-mongoadmin}
      DB01_PASS: ${MONGODB_PASSWORD:-12345678}
      DB01_AUTH: admin

      DB01_BACKUP_BEGIN: ${BACKUP_BEGIN:-1520}
      DB01_BACKUP_INTERVAL: ${BACKUP_INTERVAL:-1440}

      # Retention: delete backups older than 30 days
      DB01_CLEANUP_TIME: ${BACKUP_CLEANUP_TIME:-43200}

      # Compression
      DB01_COMPRESSION: ${BACKUP_COMPRESSION:-GZ}
      DB01_COMPRESSION_LEVEL: ${BACKUP_COMPRESSION_LEVEL:-6}
    volumes:
      - mongodb-backups:/backup
    networks:
      - ut-backend-network
    depends_on:
      mongodb:
        condition: service_healthy
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M

  llm:
    image: ${LLM_IMAGE:-}
    container_name: ut-llm
    restart: unless-stopped
    expose:
      - "8000"
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
      LOCAL_STORAGE_BASE: ${LOCAL_STORAGE_BASE:-}
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      OLLAMA_MODEL_LLM: ${OLLAMA_MODEL_LLM:-}
      OLLAMA_MODEL_CONDENSE_LLM: ${OLLAMA_MODEL_CONDENSE_LLM:-}
      OLLAMA_MODEL_VLM: ${OLLAMA_MODEL_VLM:-}
      OLLAMA_HOST_PORT: ${OLLAMA_HOST_PORT:-}
      MODELS_DIR: ${MODELS_DIR:-}
      EMBED_URL: ${EMBED_URL:-}
      EMBED_MODEL_NAME: ${EMBED_MODEL_NAME:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      RERANKER_HF_PATH: ${RERANKER_HF_PATH:-}
      RERANKER_MODEL_NAME: ${RERANKER_MODEL_NAME:-}
      RERANKER_DIR: ${RERANKER_DIR:-}
    volumes:
      - llm-ollama:/root/.ollama
      - llm-models:/root/models
      - /home/ut/understand-tech/app-data:/app/storage
    networks:
      - ut-backend-network
      - ut-frontend-network # Add the frontend network during first-time installation
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      <<: *healthcheck-defaults
      start_period: 120s
    logging: *default-logging
    stop_grace_period: 10s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  api:
    image: ${API_IMAGE:-}
    container_name: ut-api
    restart: unless-stopped
    expose:
      - "8501"
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
      TYPE_DEPLOIEMENT: ${TYPE_DEPLOIEMENT:-}
      LOCAL_STORAGE_BASE: ${LOCAL_STORAGE_BASE:-}
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      openid_scope: ${openid_scope:-}
      DOMAIN_URL: ${DOMAIN_URL:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      REDIS_PORT: ${REDIS_PORT:-}
      REDIS_HOST: ${REDIS_HOST:-}
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-}
      REDIRECT_PATH: ${REDIRECT_PATH:-}
      REDIRECT_URI: ${REDIRECT_URI:-}
      STATE_SECRET: ${STATE_SECRET:-}
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      GPU_VM_URL: ${GPU_VM_URL:-}
      OLLAMA_MODEL_LLM: ${OLLAMA_MODEL_LLM:-}
      OLLAMA_MODEL_CONDENSE_LLM: ${OLLAMA_MODEL_CONDENSE_LLM:-}
      OLLAMA_HOST_PORT: ${OLLAMA_HOST_PORT:-}
      MODELS_DIR: ${MODELS_DIR:-}
      EMBED_URL: ${EMBED_URL:-}
      EMBED_MODEL_NAME: ${EMBED_MODEL_NAME:-}
      RERANKER_HF_PATH: ${RERANKER_HF_PATH:-}
      RERANKER_MODEL_NAME: ${RERANKER_MODEL_NAME:-}
      RERANKER_DIR: ${RERANKER_DIR:-}
      ADMIN_MAIL: ${ADMIN_MAIL:-}
      BACKEND_URL: ${BACKEND_URL:-}
      OLLAMA_MODEL_VLM: ${OLLAMA_MODEL_VLM:-}
      FRONTEND_URL_AUTH: ${FRONTEND_URL_AUTH:-}
    volumes:
      - uploads-data:/tmp/uploads
      - /home/ut/understand-tech/app-data:/app/storage
    networks:
      - ut-backend-network
      - ut-frontend-network
    depends_on:
      mongodb:
        condition: service_healthy
      llm:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/api/docs"]
      <<: *healthcheck-defaults
      start_period: 60s
    logging: *default-logging
    #stop_grace_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 1G

  workers:
    image: ${WORKER_IMAGE:-}
    restart: unless-stopped
    command: ["sh", "-c", "rq worker --url redis://redis:6379 ut-api"]
    environment:
      TYPE_DEPLOIEMENT: ${TYPE_DEPLOIEMENT:-}
      BACKEND_URL: ${BACKEND_URL:-}
      LOCAL_STORAGE_BASE: ${LOCAL_STORAGE_BASE:-}
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      GPU_VM_URL: ${GPU_VM_URL:-}
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      DOMAIN_URL: ${DOMAIN_URL:-https://understand.local/}
      FRONTEND_URL_AUTH: ${FRONTEND_URL_AUTH:-}
      ADMIN_MAIL: ${ADMIN_MAIL:-}
    volumes:
      - uploads-data:/tmp/uploads
      - /home/ut/understand-tech/app-data:/app/storage
    networks:
      - ut-backend-network
      - ut-frontend-network
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      api:
        condition: service_healthy
    logging: *default-logging
    #stop_grace_period: 30s
    deploy:
      mode: replicated
      replicas: ${WORKER_REPLICAS:-}
      resources:
        limits:
          memory: 2G
          cpus: '1'
        reservations:
          memory: 512M

  frontend:
    image: ${FRONTEND_IMAGE:-}
    container_name: ut-frontend
    restart: unless-stopped
    expose:
      - "80"
    environment:
      BACKEND_URL: ${BACKEND_URL:-}
      VITE_URL_API_REST: ${VITE_URL_API_REST:-}
      VITE_AUTH_TYPE: ${VITE_AUTH_TYPE:-}
      VITE_DEPLOYMENT_TYPE: ${VITE_DEPLOYMENT_TYPE:-}
    networks:
      - ut-frontend-network
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      <<: *healthcheck-defaults
      start_period: 30s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M

  api-customer:
    image: ${API_CUSTOMER_IMAGE:-}
    container_name: ut-api-customer
    restart: unless-stopped
    expose:
      - "8501"
    environment:
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      openid_scope: ${openid_scope:-}
      OPENID_CLIENT_ID: ${OPENID_CLIENT_ID:-}
      OPENID_CLIENT_SECRET: ${OPENID_CLIENT_SECRET:-}
      OPENID_SECRET_KEY: ${OPENID_SECRET_KEY:-}
      OPENID_FRONTEND_REDIRECT_URI: ${OPENID_FRONTEND_REDIRECT_URI:-}
      DOMAIN_URL: ${DOMAIN_URL:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      REDIS_PORT: ${REDIS_PORT:-}
      REDIS_HOST: ${REDIS_HOST:-}
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-}
      REDIRECT_PATH: ${REDIRECT_PATH:-}
      REDIRECT_URI: ${REDIRECT_URI:-}
      STATE_SECRET: ${STATE_SECRET:-SECRET}
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      GPU_VM_URL: ${GPU_VM_URL:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      OA_KEY: ${OA_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      MICROSOFT_AUTHORITY: ${MICROSOFT_AUTHORITY:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      ZOHO_CLIENT_ID: ${ZOHO_CLIENT_ID:-}
      ZOHO_CLIENT_SECRET: ${ZOHO_CLIENT_SECRET:-}
      ZOHO_AUTH_URL: ${ZOHO_AUTH_URL:-}
      ZOHO_TOKEN_URL: ${ZOHO_TOKEN_URL:-}
      server_metadata_url: ${server_metadata_url:-}
      token_endpoint: ${token_endpoint:-}
      jwks_endpoint: ${jwks_endpoint:-}
      expected_issuer: ${expected_issuer:-}
      OLLAMA_MODEL_LLM: ${OLLAMA_MODEL_LLM:-}
      OLLAMA_MODEL_CONDENSE_LLM: ${OLLAMA_MODEL_CONDENSE_LLM:-}
      OLLAMA_HOST_PORT: ${OLLAMA_HOST_PORT:-}
      MODELS_DIR: ${MODELS_DIR:-}
      EMBED_URL: ${EMBED_URL:-}
      EMBED_MODEL_NAME: ${EMBED_MODEL_NAME:-}
      RERANKER_HF_PATH: ${RERANKER_HF_PATH:-}
      RERANKER_MODEL_NAME: ${RERANKER_MODEL_NAME:-}
      RERANKER_DIR: ${RERANKER_DIR:-}
      ADMIN_MAIL: ${ADMIN_MAIL:-}
      BACKEND_URL: ${BACKEND_URL:-}
      OLLAMA_MODEL_VLM: ${OLLAMA_MODEL_VLM:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      ZOHO_REDIRECT_URI: ${ZOHO_REDIRECT_URI:-}
      Google_REDIRECT_URI: ${Google_REDIRECT_URI:-}
      MICROSOFT_REDIRECT_URI: ${MICROSOFT_REDIRECT_URI:-}
      FRONTEND_URL_AUTH: ${FRONTEND_URL_AUTH:-}
      HUBSPOT_CLIENT_ID: ${HUBSPOT_CLIENT_ID:-}
      HUBSPOT_CLIENT_SECRET: ${HUBSPOT_CLIENT_SECRET:-}
      HUBSPOT_APP_ID: ${HUBSPOT_APP_ID:-}
      HUBSPOT_REDIRECT_URI: ${HUBSPOT_REDIRECT_URI:-}
    volumes:
      - uploads-data:/tmp/uploads
      - /home/ut/understand-tech/app-data:/app/storage
    networks:
      - ut-backend-network
      - ut-frontend-network
    depends_on:
      mongodb:
        condition: service_healthy
      llm:
        condition: service_healthy
      redis:
        condition: service_healthy
    #healthcheck:
      #test: ["CMD", "curl", "-f", "http://localhost:8501/api/v2/docs"]
      #<<: *healthcheck-defaults
      #start_period: 60s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4'
        reservations:
          memory: 2G

  workers-customer:
    image: ${WORKER_CUSTOMER_IMAGE:-}
    restart: unless-stopped
    command: ["sh", "-c", "rq worker --url redis://redis:6379 ut-api-partners"]
    environment:
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      GPU_VM_URL: ${GPU_VM_URL:-}
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      DOMAIN_URL: ${DOMAIN_URL:-}
      FRONTEND_URL_AUTH: ${FRONTEND_URL_AUTH:-}
      OA_KEY: ${OA_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      MICROSOFT_AUTHORITY: ${MICROSOFT_AUTHORITY:-}
      MICROSOFT_REDIRECT_URI: ${MICROSOFT_REDIRECT_URI:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      Google_REDIRECT_URI: ${Google_REDIRECT_URI:-}
      ZOHO_CLIENT_ID: ${ZOHO_CLIENT_ID:-}
      ZOHO_CLIENT_SECRET: ${ZOHO_CLIENT_SECRET:-}
      ZOHO_AUTH_URL: ${ZOHO_AUTH_URL:-}
      ZOHO_TOKEN_URL: ${ZOHO_TOKEN_URL:-}
      ZOHO_REDIRECT_URI: ${ZOHO_REDIRECT_URI:-}
      HUBSPOT_CLIENT_ID: ${HUBSPOT_CLIENT_ID:-}
      HUBSPOT_CLIENT_SECRET: ${HUBSPOT_CLIENT_SECRET:-}
      HUBSPOT_REDIRECT_URI: ${HUBSPOT_REDIRECT_URI:-}
      server_metadata_url: ${server_metadata_url:-}
      token_endpoint: ${token_endpoint:-}
      jwks_endpoint: ${jwks_endpoint:-}
      expected_issuer: ${expected_issuer:-}
      ADMIN_MAIL: ${ADMIN_MAIL:-}
    volumes:
      - uploads-data:/tmp/uploads
      - /home/ut/understand-tech/app-data:/app/storage
    networks:
      - ut-backend-network
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    logging: *default-logging
    deploy:
      mode: replicated
      replicas: ${WORKER_CUSTOMER_REPLICAS:-}
      resources:
        limits:
          memory: 8G
          cpus: '4'
        reservations:
          memory: 2G

networks:
  ut-backend-network:
    name: ut-backend-network
    driver: bridge
    internal: true
  ut-frontend-network:
    name: ut-frontend-network
    driver: bridge

volumes:
  caddy-data:
    name: ut-caddy-data
  caddy-config:
    name: ut-caddy-config
  redis-data:
    name: ut-redis-data
  uploads-data:
    name: ut-uploads-data
  mongodb-data:
    name: ut-mongodb-data
  mongodb-backups:
    name: ut-mongodb-backup
  llm-ollama:
    name: ut-llm-ollama
  llm-models:
    name: ut-llm-models
