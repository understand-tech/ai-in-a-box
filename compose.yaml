name: understandtech

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "5"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3

services:

  caddy:
    image: caddy:2-alpine
    container_name: ut-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - ut-frontend-network
    depends_on:
      api:
        condition: service_healthy
      frontend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      <<: *healthcheck-defaults
      start_period: 10s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 64M

  redis:
    image: redis:7.2-alpine
    container_name: ut-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
    expose:
      - "6379"
    volumes:
      - redis-data:/data
    networks:
      - ut-backend-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      <<: *healthcheck-defaults
      interval: 10s
      start_period: 5s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 256M

  mongodb:
    image: mongo:8.2
    container_name: ut-mongodb
    restart: unless-stopped
    expose:
      - "27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USERNAME:-}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-}
    command: >
      mongod
      --wiredTigerCacheSizeGB 1
      --setParameter diagnosticDataCollectionEnabled=false
    volumes:
      - mongodb-data:/data/db
    networks:
      - ut-backend-network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok", "-u", "${MONGODB_USERNAME:-mongoadmin}", "-p", "${MONGODB_PASSWORD:-12345678}", "--authenticationDatabase", "admin"]
      <<: *healthcheck-defaults
      start_period: 30s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 1G

  llm:
    image: ${LLM_IMAGE:-ghcr.io/understand-tech/ut-llm-customer:latest-arm64}
    container_name: ut-llm
    restart: unless-stopped
    expose:
      - "8000"
    environment:
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      OA_KEY: ${OA_KEY:-}
      UT_KEY: ${UT_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      OLLAMA_MODEL_LLM: ${OLLAMA_MODEL_LLM:-}
      OLLAMA_MODEL_CONDENSE_LLM: ${OLLAMA_MODEL_CONDENSE_LLM:-}
      OLLAMA_MODEL_VLM: ${OLLAMA_MODEL_VLM:-}
      OLLAMA_HOST_PORT: ${OLLAMA_HOST_PORT:-}
      MODELS_DIR: ${MODELS_DIR:-}
      EMBED_URL: ${EMBED_URL:-}
      EMBED_MODEL_NAME: ${EMBED_MODEL_NAME:-}
      S3_REGION: ${S3_REGION:-}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      UT_USERS_DATA_BUCKET: ${UT_USERS_DATA_BUCKET:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      RERANKER_HF_PATH: ${RERANKER_HF_PATH:-}
      RERANKER_MODEL_NAME: ${RERANKER_MODEL_NAME:-}
      RERANKER_DIR: ${RERANKER_DIR:-}
      storageBucket: ${storageBucket:-}
      databaseURL: ${databaseURL:-}
      apiKey: ${apiKey:-}
      authDomain: ${authDomain:-}
      projectId: ${projectId:-}
      messagingSenderId: ${messagingSenderId:-}
      appId: ${appId:-}
      measurementId: ${measurementId:-}
      serviceAccountKey: ${serviceAccountKey:-}
    volumes:
      - llm-ollama:/root/.ollama
      - llm-models:/root/models
    networks:
      - ut-backend-network
      - ut-frontend-network # Add the frontend network during first-time installation
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      <<: *healthcheck-defaults
      start_period: 120s
    logging: *default-logging
    stop_grace_period: 10s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  api:
    image: ${API_IMAGE:-ghcr.io/understand-tech/ut-api-customer:1.0.1-arm64}
    container_name: ut-api
    restart: unless-stopped
    expose:
      - "8501"
    environment:
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      openid_scope: ${openid_scope:-}
      OPENID_CLIENT_ID: ${OPENID_CLIENT_ID:-}
      OPENID_CLIENT_SECRET: ${OPENID_CLIENT_SECRET:-}
      OPENID_SECRET_KEY: ${OPENID_SECRET_KEY:-}
      OPENID_FRONTEND_REDIRECT_URI: ${OPENID_FRONTEND_REDIRECT_URI:-}
      DOMAIN_URL: ${DOMAIN_URL:-}
      S3_REGION: ${S3_REGION:-}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      UT_USERS_DATA_BUCKET: ${UT_USERS_DATA_BUCKET:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      REDIS_PORT: ${REDIS_PORT:-}
      REDIS_HOST: ${REDIS_HOST:-}
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-}
      REDIRECT_PATH: ${REDIRECT_PATH:-}
      REDIRECT_URI: ${REDIRECT_URI:-}
      STATE_SECRET: ${STATE_SECRET:-}
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      GPU_VM_URL: ${GPU_VM_URL:-}
      AZURE_SQL_DATABASE: ${AZURE_SQL_DATABASE:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      AZURE_SQL_USERNAME: ${AZURE_SQL_USERNAME:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      OA_KEY: ${OA_KEY:-}
      UT_KEY: ${UT_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      AZURE_SQL_PASSWORD: ${AZURE_SQL_PASSWORD:-}
      AZURE_SQL_SERVER: ${AZURE_SQL_SERVER:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      MICROSOFT_AUTHORITY: ${MICROSOFT_AUTHORITY:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      ZOHO_CLIENT_ID: ${ZOHO_CLIENT_ID:-}
      ZOHO_CLIENT_SECRET: ${ZOHO_CLIENT_SECRET:-}
      ZOHO_AUTH_URL: ${ZOHO_AUTH_URL:-}
      ZOHO_TOKEN_URL: ${ZOHO_TOKEN_URL:-}
      server_metadata_url: ${server_metadata_url:-}
      token_endpoint: ${token_endpoint:-}
      jwks_endpoint: ${jwks_endpoint:-}
      expected_issuer: ${expected_issuer:-}
      OLLAMA_MODEL_LLM: ${OLLAMA_MODEL_LLM:-}
      OLLAMA_MODEL_CONDENSE_LLM: ${OLLAMA_MODEL_CONDENSE_LLM:-}
      OLLAMA_HOST_PORT: ${OLLAMA_HOST_PORT:-}
      MODELS_DIR: ${MODELS_DIR:-}
      EMBED_URL: ${EMBED_URL:-}
      EMBED_MODEL_NAME: ${EMBED_MODEL_NAME:-}
      RERANKER_HF_PATH: ${RERANKER_HF_PATH:-}
      RERANKER_MODEL_NAME: ${RERANKER_MODEL_NAME:-}
      RERANKER_DIR: ${RERANKER_DIR:-}
      ADMIN_MAIL: ${ADMIN_MAIL:-}
      storageBucket: ${storageBucket:-}
      databaseURL: ${databaseURL:-}
      apiKey: ${apiKey:-}
      authDomain: ${authDomain:-}
      projectId: ${projectId:-}
      messagingSenderId: ${messagingSenderId:-}
      appId: ${appId:-}
      measurementId: ${measurementId:-}
      BACKEND_URL: ${BACKEND_URL:-}
      serviceAccountKey: ${serviceAccountKey:-}
      OLLAMA_MODEL_VLM: ${OLLAMA_MODEL_VLM:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      ZOHO_REDIRECT_URI: ${ZOHO_REDIRECT_URI:-}
      Google_REDIRECT_URI: ${Google_REDIRECT_URI:-}
      MICROSOFT_REDIRECT_URI: ${MICROSOFT_REDIRECT_URI:-}
      FRONTEND_URL_AUTH: ${FRONTEND_URL_AUTH:-}
      HUBSPOT_CLIENT_ID: ${HUBSPOT_CLIENT_ID:-}
      HUBSPOT_CLIENT_SECRET: ${HUBSPOT_CLIENT_SECRET:-}
      HUBSPOT_APP_ID: ${HUBSPOT_APP_ID:-}
      HUBSPOT_REDIRECT_URI: ${HUBSPOT_REDIRECT_URI:-}
    volumes:
      - uploads-data:/tmp/uploads
    networks:
      - ut-backend-network
      - ut-frontend-network
    depends_on:
      mongodb:
        condition: service_healthy
      llm:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/api/docs"]
      <<: *healthcheck-defaults
      start_period: 60s
    logging: *default-logging
    #stop_grace_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 1G

  workers:
    image: ${WORKER_IMAGE:-ghcr.io/understand-tech/ut-worker-customer:1.0.1-arm64}
    restart: unless-stopped
    command: ["sh", "-c", "rq worker --url redis://redis:6379 ut-api"]
    environment:
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      GPU_VM_URL: ${GPU_VM_URL:-
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      DOMAIN_URL: ${DOMAIN_URL:-https://understand.local/}
      S3_REGION: ${S3_REGION:-}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      UT_USERS_DATA_BUCKET: ${UT_USERS_DATA_BUCKET:-}
      FRONTEND_URL_AUTH: ${FRONTEND_URL_AUTH:-}
      OA_KEY: ${OA_KEY:-}
      UT_KEY: ${UT_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      MICROSOFT_AUTHORITY: ${MICROSOFT_AUTHORITY:-}
      MICROSOFT_REDIRECT_URI: ${MICROSOFT_REDIRECT_URI:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      Google_REDIRECT_URI: ${Google_REDIRECT_URI:-}
      ZOHO_CLIENT_ID: ${ZOHO_CLIENT_ID:-}
      ZOHO_CLIENT_SECRET: ${ZOHO_CLIENT_SECRET:-}
      ZOHO_AUTH_URL: ${ZOHO_AUTH_URL:-}
      ZOHO_TOKEN_URL: ${ZOHO_TOKEN_URL:-}
      ZOHO_REDIRECT_URI: ${ZOHO_REDIRECT_URI:-}
      HUBSPOT_CLIENT_ID: ${HUBSPOT_CLIENT_ID:-}
      HUBSPOT_CLIENT_SECRET: ${HUBSPOT_CLIENT_SECRET:-}
      HUBSPOT_REDIRECT_URI: ${HUBSPOT_REDIRECT_URI:-}
      server_metadata_url: ${server_metadata_url:-}
      token_endpoint: ${token_endpoint:-}
      jwks_endpoint: ${jwks_endpoint:-}
      expected_issuer: ${expected_issuer:-}
      storageBucket: ${storageBucket:-}
      databaseURL: ${databaseURL:-}
      apiKey: ${apiKey:-}
      authDomain: ${authDomain:-}
      projectId: ${projectId:-}
      messagingSenderId: ${messagingSenderId:-}
      appId: ${appId:-}
      measurementId: ${measurementId:-}
      serviceAccountKey: ${serviceAccountKey:-}
      ADMIN_MAIL: ${ADMIN_MAIL:-}
    volumes:
      - uploads-data:/tmp/uploads
    networks:
      - ut-backend-network
      - ut-frontend-network
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      api:
        condition: service_healthy
    logging: *default-logging
    #stop_grace_period: 30s
    deploy:
      mode: replicated
      replicas: ${WORKER_REPLICAS:-2}
      resources:
        limits:
          memory: 2G
          cpus: '1'
        reservations:
          memory: 512M

  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/understand-tech/ut-frontend-customer:7b8fecea903fd6e12bec0cc4d3a52cdf5e5ba813@sha256:4718492dfedab2a1a30546a299da6617b52b1a5e75dbf35007228adb6e0e51c1}
    container_name: ut-frontend
    restart: unless-stopped
    expose:
      - "80"
    environment:
      BACKEND_URL: ${BACKEND_URL:-}
      VITE_FIREBASE_API_KEY: ${VITE_FIREBASE_API_KEY:-}
      VITE_FIREBASE_AUTH_DOMAIN: ${VITE_FIREBASE_AUTH_DOMAIN:-}
      VITE_FIREBASE_PROJECT_ID: ${VITE_FIREBASE_PROJECT_ID:-}
      VITE_FIREBASE_STORAGE_BUCKET: ${VITE_FIREBASE_STORAGE_BUCKET:-}
      VITE_FIREBASE_MESSAGING_SENDER_ID: ${VITE_FIREBASE_MESSAGING_SENDER_ID:-}
      VITE_FIREBASE_APP_ID: ${VITE_FIREBASE_APP_ID:-}
      VITE_GOOGLE_APP_ID: ${VITE_GOOGLE_APP_ID:-}
      VITE_URL_API_REST: ${VITE_URL_API_REST:-}
      VITE_AUTH_TYPE: ${VITE_AUTH_TYPE:-}
    networks:
      - ut-frontend-network
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      <<: *healthcheck-defaults
      start_period: 30s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M

  api-customer:
    image: ${API_CUSTOMER_IMAGE:-ghcr.io/understand-tech/ut-api-rest-customer:latest-arm64}
    container_name: ut-api-customer
    restart: unless-stopped
    expose:
      - "8501"
    environment:
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      openid_scope: ${openid_scope:-}
      OPENID_CLIENT_ID: ${OPENID_CLIENT_ID:-}
      OPENID_CLIENT_SECRET: ${OPENID_CLIENT_SECRET:-}
      OPENID_SECRET_KEY: ${OPENID_SECRET_KEY:-}
      OPENID_FRONTEND_REDIRECT_URI: ${OPENID_FRONTEND_REDIRECT_URI:-}
      DOMAIN_URL: ${DOMAIN_URL:-}
      S3_REGION: ${S3_REGION:-}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      UT_USERS_DATA_BUCKET: ${UT_USERS_DATA_BUCKET:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      REDIS_PORT: ${REDIS_PORT:-}
      REDIS_HOST: ${REDIS_HOST:-}
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-}
      REDIRECT_PATH: ${REDIRECT_PATH:-
      REDIRECT_URI: ${REDIRECT_URI:-}
      STATE_SECRET: ${STATE_SECRET:-SECRET}
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      GPU_VM_URL: ${GPU_VM_URL:-}
      AZURE_SQL_DATABASE: ${AZURE_SQL_DATABASE:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      AZURE_SQL_USERNAME: ${AZURE_SQL_USERNAME:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      OA_KEY: ${OA_KEY:-}
      UT_KEY: ${UT_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      AZURE_SQL_PASSWORD: ${AZURE_SQL_PASSWORD:-}
      AZURE_SQL_SERVER: ${AZURE_SQL_SERVER:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      MICROSOFT_AUTHORITY: ${MICROSOFT_AUTHORITY:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      ZOHO_CLIENT_ID: ${ZOHO_CLIENT_ID:-}
      ZOHO_CLIENT_SECRET: ${ZOHO_CLIENT_SECRET:-}
      ZOHO_AUTH_URL: ${ZOHO_AUTH_URL:-}
      ZOHO_TOKEN_URL: ${ZOHO_TOKEN_URL:-}
      server_metadata_url: ${server_metadata_url:-}
      token_endpoint: ${token_endpoint:-}
      jwks_endpoint: ${jwks_endpoint:-}
      expected_issuer: ${expected_issuer:-}
      OLLAMA_MODEL_LLM: ${OLLAMA_MODEL_LLM:-}
      OLLAMA_MODEL_CONDENSE_LLM: ${OLLAMA_MODEL_CONDENSE_LLM:-}
      OLLAMA_HOST_PORT: ${OLLAMA_HOST_PORT:-}
      MODELS_DIR: ${MODELS_DIR:-}
      EMBED_URL: ${EMBED_URL:-}
      EMBED_MODEL_NAME: ${EMBED_MODEL_NAME:-}
      RERANKER_HF_PATH: ${RERANKER_HF_PATH:-}
      RERANKER_MODEL_NAME: ${RERANKER_MODEL_NAME:-}
      RERANKER_DIR: ${RERANKER_DIR:-}
      ADMIN_MAIL: ${ADMIN_MAIL:-}
      storageBucket: ${storageBucket:-}
      databaseURL: ${databaseURL:-}
      apiKey: ${apiKey:-}
      authDomain: ${authDomain:-}
      projectId: ${projectId:-}
      messagingSenderId: ${messagingSenderId:-}
      appId: ${appId:-}
      measurementId: ${measurementId:-}
      BACKEND_URL: ${BACKEND_URL:-}
      serviceAccountKey: ${serviceAccountKey:-}
      OLLAMA_MODEL_VLM: ${OLLAMA_MODEL_VLM:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      ZOHO_REDIRECT_URI: ${ZOHO_REDIRECT_URI:-}
      Google_REDIRECT_URI: ${Google_REDIRECT_URI:-}
      MICROSOFT_REDIRECT_URI: ${MICROSOFT_REDIRECT_URI:-}
      FRONTEND_URL_AUTH: ${FRONTEND_URL_AUTH:-}
      HUBSPOT_CLIENT_ID: ${HUBSPOT_CLIENT_ID:-}
      HUBSPOT_CLIENT_SECRET: ${HUBSPOT_CLIENT_SECRET:-}
      HUBSPOT_APP_ID: ${HUBSPOT_APP_ID:-}
      HUBSPOT_REDIRECT_URI: ${HUBSPOT_REDIRECT_URI:-}
    volumes:
      - uploads-data:/tmp/uploads
    networks:
      - ut-backend-network
      - ut-frontend-network
    depends_on:
      mongodb:
        condition: service_healthy
      llm:
        condition: service_healthy
      redis:
        condition: service_healthy
    #healthcheck:
      #test: ["CMD", "curl", "-f", "http://localhost:8501/api/v2/docs"]
      #<<: *healthcheck-defaults
      #start_period: 60s
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4'
        reservations:
          memory: 2G

  workers-customer:
    image: ${WORKER_CUSTOMER_IMAGE:-ghcr.io/understand-tech/ut-worker-rest-customer:latest-arm64}
    restart: unless-stopped
    command: ["sh", "-c", "rq worker --url redis://redis:6379 ut-api-partners"]
    environment:
      DB_PROVIDER: ${DB_PROVIDER:-}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-}
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-}
      MONGODB_HOST: ${MONGODB_HOST:-}
      MONGODB_PORT: ${MONGODB_PORT:-}
      MONGODB_USERNAME: ${MONGODB_USERNAME:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-}
      GPU_VM_URL: ${GPU_VM_URL:-}
      GPU_VM_API_TOKEN: ${GPU_VM_API_TOKEN:-}
      DOMAIN_URL: ${DOMAIN_URL:-}
      S3_REGION: ${S3_REGION:-eu-central-1}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      UT_USERS_DATA_BUCKET: ${UT_USERS_DATA_BUCKET:-}
      FRONTEND_URL_AUTH: ${FRONTEND_URL_AUTH:-}
      OA_KEY: ${OA_KEY:-}
      UT_KEY: ${UT_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      MICROSOFT_AUTHORITY: ${MICROSOFT_AUTHORITY:-}
      MICROSOFT_REDIRECT_URI: ${MICROSOFT_REDIRECT_URI:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      Google_REDIRECT_URI: ${Google_REDIRECT_URI:-}
      ZOHO_CLIENT_ID: ${ZOHO_CLIENT_ID:-}
      ZOHO_CLIENT_SECRET: ${ZOHO_CLIENT_SECRET:-}
      ZOHO_AUTH_URL: ${ZOHO_AUTH_URL:-}
      ZOHO_TOKEN_URL: ${ZOHO_TOKEN_URL:-}
      ZOHO_REDIRECT_URI: ${ZOHO_REDIRECT_URI:-}
      HUBSPOT_CLIENT_ID: ${HUBSPOT_CLIENT_ID:-}
      HUBSPOT_CLIENT_SECRET: ${HUBSPOT_CLIENT_SECRET:-}
      HUBSPOT_REDIRECT_URI: ${HUBSPOT_REDIRECT_URI:-}
      server_metadata_url: ${server_metadata_url:-}
      token_endpoint: ${token_endpoint:-}
      jwks_endpoint: ${jwks_endpoint:-}
      expected_issuer: ${expected_issuer:-}
      storageBucket: ${storageBucket:-}
      databaseURL: ${databaseURL:-}
      apiKey: ${apiKey:-}
      authDomain: ${authDomain:-}
      projectId: ${projectId:-}
      messagingSenderId: ${messagingSenderId:-}
      appId: ${appId:-}
      measurementId: ${measurementId:-}
      serviceAccountKey: ${serviceAccountKey:-}
      ADMIN_MAIL: ${ADMIN_MAIL:-}
    volumes:
      - uploads-data:/tmp/uploads
    networks:
      - ut-backend-network
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    logging: *default-logging
    deploy:
      mode: replicated
      replicas: ${WORKER_CUSTOMER_REPLICAS:-2}
      resources:
        limits:
          memory: 8G
          cpus: '4'
        reservations:
          memory: 2G

networks:
  ut-backend-network:
    name: ut-backend-network
    driver: bridge
    internal: true
  ut-frontend-network:
    name: ut-frontend-network
    driver: bridge

volumes:
  caddy-data:
    name: ut-caddy-data
  caddy-config:
    name: ut-caddy-config
  redis-data:
    name: ut-redis-data
  uploads-data:
    name: ut-uploads-data
  mongodb-data:
    name: ut-mongodb-data
  llm-ollama:
    name: ut-llm-ollama
  llm-models:
    name: ut-llm-models