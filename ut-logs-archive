#!/bin/bash
# UnderstandTech Log Archiver
# Automatically exports Docker logs to daily files with configurable retention
#
# Usage:
#   ./ut-logs-archive              # Run archive (call from cron)
#   ./ut-logs-archive --install    # Install daily cron job
#   ./ut-logs-archive --status     # Show archive status
#   ./ut-logs-archive --cleanup    # Manual cleanup of old archives
#
# In order to run this script, turn it into an executable by running:
#   chmod +x ./ut-logs-archive
#

# =============================================================================
# CONFIGURATION - Edit these as needed
# =============================================================================

ARCHIVE_DIR="/var/log/understandtech"     # Where to store archived logs
RETENTION_DAYS=365                        # How long to keep archives (1 year)
CONTAINER_PREFIX="ut-"                    # Only archive containers starting with this
WORKER_PREFIX="understandtech-workers"    # Also archive worker containers
ARCHIVE_HOUR="02:00"                      # When daily cron runs (24h format)

# =============================================================================
# Don't edit below unless you know what you're doing
# =============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

TODAY=$(date +%Y-%m-%d)
MONTH=$(date +%Y-%m)

log_info()  { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Get all UT containers (main services + workers)
get_containers() {
    docker ps --format '{{.Names}}' | grep -E "^(${CONTAINER_PREFIX}|${WORKER_PREFIX})" | sort
}

# Main archive function - exports last 24h of logs for each container
do_archive() {
    log_info "Starting log archive for ${TODAY}"
    
    # Create directory structure: ARCHIVE_DIR/YYYY-MM/DD/
    local day_dir="${ARCHIVE_DIR}/${MONTH}/${TODAY}"
    mkdir -p "$day_dir"
    
    local archived=0
    local skipped=0
    local failed=0
    
    for container in $(get_containers); do
        local archive_file="${day_dir}/${container}.log.gz"
        
        # Skip if already archived today
        if [[ -f "$archive_file" ]]; then
            ((skipped++))
            continue
        fi
        
        # Export and compress
        if docker logs --since 24h "$container" 2>&1 | gzip > "$archive_file"; then
            # Check if file has content (more than just gzip header ~20 bytes)
            local filesize
            filesize=$(stat -c%s "$archive_file" 2>/dev/null || echo "0")
            
            if [[ "$filesize" -gt 20 ]]; then
                ((archived++))
            else
                # Empty log, remove the file
                rm -f "$archive_file"
                ((skipped++))
            fi
        else
            log_error "Failed to archive ${container}"
            rm -f "$archive_file"
            ((failed++))
        fi
    done
    
    log_info "Archive complete: ${archived} archived, ${skipped} skipped, ${failed} failed"
    log_info "Location: ${day_dir}"
    
    # Run cleanup
    do_cleanup
}

# Cleanup old archives beyond retention period
do_cleanup() {
    log_info "Cleaning archives older than ${RETENTION_DAYS} days"
    
    local deleted
    deleted=$(find "$ARCHIVE_DIR" -name "*.log.gz" -mtime +${RETENTION_DAYS} -delete -print 2>/dev/null | wc -l)
    
    if [[ $deleted -gt 0 ]]; then
        log_info "Deleted ${deleted} old archive files"
    fi
    
    # Remove empty directories
    find "$ARCHIVE_DIR" -type d -empty -delete 2>/dev/null || true
}

# Show archive status
do_status() {
    echo -e "${CYAN}UnderstandTech Log Archive Status${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Archive location:  ${ARCHIVE_DIR}"
    echo "Retention period:  ${RETENTION_DAYS} days"
    echo "Containers:        ${CONTAINER_PREFIX}* and ${WORKER_PREFIX}*"
    echo ""
    
    if [[ ! -d "$ARCHIVE_DIR" ]]; then
        log_warn "Archive directory does not exist yet"
        echo "Run './ut-logs-archive' to create first archive"
        return
    fi
    
    # Calculate stats
    local total_size=$(du -sh "$ARCHIVE_DIR" 2>/dev/null | cut -f1 || echo "0")
    local day_count=$(find "$ARCHIVE_DIR" -mindepth 2 -maxdepth 2 -type d 2>/dev/null | wc -l)
    local file_count=$(find "$ARCHIVE_DIR" -name "*.log.gz" 2>/dev/null | wc -l)
    local oldest=$(find "$ARCHIVE_DIR" -mindepth 2 -maxdepth 2 -type d 2>/dev/null | sort | head -1 | xargs basename 2>/dev/null || echo "none")
    local newest=$(find "$ARCHIVE_DIR" -mindepth 2 -maxdepth 2 -type d 2>/dev/null | sort | tail -1 | xargs basename 2>/dev/null || echo "none")
    
    echo -e "${GREEN}Archive Statistics:${NC}"
    echo "  Total size:    ${total_size}"
    echo "  Days archived: ${day_count}"
    echo "  Total files:   ${file_count}"
    echo "  Date range:    ${oldest} → ${newest}"
    echo ""
    
    echo -e "${GREEN}Archives by Month:${NC}"
    for month_dir in "$ARCHIVE_DIR"/*/; do
        [[ -d "$month_dir" ]] || continue
        local month=$(basename "$month_dir")
        local days=$(find "$month_dir" -mindepth 1 -maxdepth 1 -type d | wc -l)
        local files=$(find "$month_dir" -name "*.log.gz" | wc -l)
        local size=$(du -sh "$month_dir" | cut -f1)
        printf "  %-10s %3d days  %4d files  %8s\n" "$month" "$days" "$files" "$size"
    done
    echo ""
    
    # Check cron status
    if crontab -l 2>/dev/null | grep -q "ut-logs-archive"; then
        echo -e "${GREEN}✓${NC} Cron job is installed"
        crontab -l | grep ut-logs-archive | sed 's/^/  /'
    else
        echo -e "${YELLOW}⚠${NC} Cron job not installed. Run: ./ut-logs-archive --install"
    fi
}

# Install cron job
do_install() {
    local script_path=$(realpath "$0")
    local hour=$(echo "$ARCHIVE_HOUR" | cut -d: -f1)
    local minute=$(echo "$ARCHIVE_HOUR" | cut -d: -f2)
    local cron_line="${minute} ${hour} * * * ${script_path} >> /var/log/ut-logs-archive.log 2>&1"
    
    echo -e "${CYAN}Install Log Archive Cron Job${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "This will:"
    echo "  • Run daily at ${ARCHIVE_HOUR}"
    echo "  • Archive logs to ${ARCHIVE_DIR}"
    echo "  • Keep logs for ${RETENTION_DAYS} days"
    echo ""
    echo "Cron entry:"
    echo -e "  ${CYAN}${cron_line}${NC}"
    echo ""
    
    read -p "Install cron job? (y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        # Create archive directory
        sudo mkdir -p "$ARCHIVE_DIR"
        sudo chown "$(whoami):$(whoami)" "$ARCHIVE_DIR"
        
        # Create log file
        sudo touch /var/log/ut-logs-archive.log
        sudo chown "$(whoami):$(whoami)" /var/log/ut-logs-archive.log
        
        # Add cron job - write to temp file first for reliability
        local temp_cron=$(mktemp)
        crontab -l 2>/dev/null | grep -v "ut-logs-archive" > "$temp_cron" || true
        echo "$cron_line" >> "$temp_cron"
        crontab "$temp_cron"
        rm -f "$temp_cron"
        
        # Verify it worked
        echo ""
        if crontab -l 2>/dev/null | grep -q "ut-logs-archive"; then
            log_info "Cron job installed successfully!"
            echo ""
            echo "Installed cron entry:"
            crontab -l | grep ut-logs-archive
        else
            log_error "Cron job installation failed!"
            echo "Try manually:"
            echo "  crontab -e"
            echo "  # Add this line:"
            echo "  ${cron_line}"
        fi
        echo ""
        echo "To view archive log: tail -f /var/log/ut-logs-archive.log"
    else
        echo "Cancelled."
    fi
}

# Uninstall cron job
do_uninstall() {
    echo -e "${CYAN}Uninstall Log Archive Cron Job${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    
    if ! crontab -l 2>/dev/null | grep -q "ut-logs-archive"; then
        log_warn "No cron job found for ut-logs-archive"
        return
    fi
    
    echo "Current cron entry:"
    crontab -l | grep ut-logs-archive | sed 's/^/  /'
    echo ""
    
    read -p "Remove this cron job? (y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        local temp_cron=$(mktemp)
        crontab -l 2>/dev/null | grep -v "ut-logs-archive" > "$temp_cron"
        crontab "$temp_cron"
        rm -f "$temp_cron"
        
        if crontab -l 2>/dev/null | grep -q "ut-logs-archive"; then
            log_error "Failed to remove cron job"
        else
            log_info "Cron job removed successfully!"
            echo ""
            echo "Note: Existing archives in ${ARCHIVE_DIR} are preserved."
            echo "To delete archives: rm -rf ${ARCHIVE_DIR}"
        fi
    else
        echo "Cancelled."
    fi
}

# Manual cleanup command
do_manual_cleanup() {
    echo -e "${CYAN}Manual Archive Cleanup${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    
    local old_files=$(find "$ARCHIVE_DIR" -name "*.log.gz" -mtime +${RETENTION_DAYS} 2>/dev/null)
    local count=$(echo "$old_files" | grep -c . || echo 0)
    
    if [[ $count -eq 0 ]]; then
        log_info "No archives older than ${RETENTION_DAYS} days"
        return
    fi
    
    echo "Found ${count} files older than ${RETENTION_DAYS} days:"
    echo "$old_files" | head -20
    [[ $count -gt 20 ]] && echo "  ... and $((count - 20)) more"
    echo ""
    
    read -p "Delete these files? (y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        do_cleanup
        log_info "Cleanup complete"
    else
        echo "Cancelled."
    fi
}

# Show help
do_help() {
    echo -e "${CYAN}UnderstandTech Log Archiver${NC}"
    echo ""
    echo "Automatically exports Docker container logs to daily compressed files."
    echo ""
    echo -e "${GREEN}Usage:${NC}"
    echo "  ./ut-logs-archive              Run archive now (exports last 24h)"
    echo "  ./ut-logs-archive --install    Install daily cron job"
    echo "  ./ut-logs-archive --uninstall  Remove cron job"
    echo "  ./ut-logs-archive --status     Show archive status and stats"
    echo "  ./ut-logs-archive --cleanup    Manually cleanup old archives"
    echo "  ./ut-logs-archive --help       Show this help"
    echo ""
    echo -e "${GREEN}Configuration:${NC} (edit variables at top of script)"
    echo "  ARCHIVE_DIR       ${ARCHIVE_DIR}"
    echo "  RETENTION_DAYS    ${RETENTION_DAYS} days"
    echo "  CONTAINER_PREFIX  ${CONTAINER_PREFIX}*"
    echo "  WORKER_PREFIX     ${WORKER_PREFIX}*"
    echo "  ARCHIVE_HOUR      ${ARCHIVE_HOUR}"
    echo ""
    echo -e "${GREEN}Archive Structure:${NC}"
    echo "  ${ARCHIVE_DIR}/"
    echo "  ├── 2026-01/"
    echo "  │   ├── 2026-01-01/"
    echo "  │   │   ├── ut-api.log.gz"
    echo "  │   │   ├── ut-mongodb.log.gz"
    echo "  │   │   └── ut-llm.log.gz"
    echo "  │   ├── 2026-01-02/"
    echo "  │   │   └── ..."
    echo "  │   └── ..."
    echo "  ├── 2026-02/"
    echo "  │   └── ..."
    echo "  └── ..."
    echo ""
    echo -e "${GREEN}Accessing Archived Logs:${NC}"
    echo "  # View archived log"
    echo "  zcat ${ARCHIVE_DIR}/2026-01/2026-01-15/ut-api.log.gz | less"
    echo ""
    echo "  # Search a specific day"
    echo "  zgrep \"error\" ${ARCHIVE_DIR}/2026-01/2026-01-15/*.log.gz"
    echo ""
    echo "  # Search entire month"
    echo "  zgrep \"error\" ${ARCHIVE_DIR}/2026-01/*/ut-api.log.gz"
    echo ""
    echo "  # Extract a day's logs"
    echo "  mkdir export && gunzip -c ${ARCHIVE_DIR}/2026-01/2026-01-15/*.log.gz > export/"
    echo ""
}

# =============================================================================
# Main
# =============================================================================

case "${1:-}" in
    --install|-i)
        do_install
        ;;
    --uninstall|-u)
        do_uninstall
        ;;
    --status|-s)
        do_status
        ;;
    --cleanup|-c)
        do_manual_cleanup
        ;;
    --help|-h)
        do_help
        ;;
    "")
        do_archive
        ;;
    *)
        log_error "Unknown option: $1"
        do_help
        exit 1
        ;;
esac
